# Modello di Poisson

::: callout-important
## In questo capitolo imparerai a

- utilizzare **brms** per adattare ai dati un modello di Poisson.

:::

::: callout-tip
## Prerequisiti

- Leggere [Racial Disparities in Police Use of Deadly Force Against Unarmed Individuals Persist After Appropriately Benchmarking Shooting Data on Violent Crime Rates](https://journals.sagepub.com/doi/full/10.1177/1948550620916071) per ottenere una panoramica approfondita su questo fenomeno e sul relativo ambito di ricerca.
:::

::: callout-important
## Preparazione del Notebook

```{r}
here::here("code", "_common.R") |> 
  source()

# Load packages
if (!requireNamespace("pacman")) install.packages("pacman")
pacman::p_load(HDInterval, lubridate, brms, bayesplot, tidybayes)
```
:::


## Introduzione

Nel capitolo precedente abbiamo visto come, in un contesto bayesiano, la distribuzione a posteriori del parametro di una distribuzione di Poisson possa essere calcolata usando una prior Gamma. In questo capitolo, mostreremo come eseguire un’analisi simile in **R** usando il pacchetto **brms**, focalizzandoci sull’interpretazione diretta del tasso $\lambda$ di sparatorie fatali per anno negli Stati Uniti.

## Domanda della ricerca

Analizziamo i dati raccolti dal *Washington Post* su tutte le sparatorie fatali da parte della polizia statunitense dal 2015. Il nostro obiettivo è stimare il tasso medio annuo $\lambda$ di queste sparatorie e quantificare l’incertezza associata.

## Preparazione dei dati

Importiamo i dati direttamente da GitHub:

```{r}
url <- "https://raw.githubusercontent.com/washingtonpost/data-police-shootings/master/v2/fatal-police-shootings-data.csv"
fps_dat <- read.csv(url, stringsAsFactors = FALSE)
fps_dat$date <- as.Date(fps_dat$date)
fps_dat$year <- as.numeric(format(fps_dat$date, "%Y"))
fps <- subset(fps_dat, year != 2025)  # Rimuove dati parziali del 2025
```

Creiamo un dataset aggregato per anno:

```{r}
year_counts <- table(fps$year)
df <- data.frame(
  year   = as.numeric(names(year_counts)),
  events = as.vector(year_counts)
)
```

## Specifica del modello

Assumiamo che il numero di sparatorie $Y$ in ciascun anno segua una distribuzione di Poisson con tasso costante $\lambda$:

$$
Y \sim \text{Poisson}(\lambda)
$$

Vogliamo stimare $\lambda$, che rappresenta il numero medio di eventi per anno.

## Scelta della distribuzione a priori

Invece di ragionare in termini di $\log(\lambda)$, possiamo scegliere una distribuzione lognormale che, trasformata, abbia una media plausibile per $\lambda$. Supponiamo di credere, a priori, che il numero medio annuo di sparatorie sia circa 600, con incertezza di circa ±200.

Una distribuzione lognormale approssima bene questa idea. Una `normal(6.4, 0.3)` sul logaritmo corrisponde a una distribuzione su $\lambda$ centrata intorno a 600, con valori plausibili tra circa 400 e 900.

Scriviamo:

```{r}
prior_lambda <- c(
  prior(normal(6.4, 0.3), class = "Intercept")
)
```

Anche se specifichiamo la prior su $\log(\lambda)$ (per compatibilità con `brms`), interpreteremo i risultati direttamente sulla scala di $\lambda$.

## Stima di $\lambda$ con `brms`

Costruiamo un modello molto semplice, senza effetti per anno:

```{r}
#| message: false
#| warning: false
#| output: false
#| 
m0 <- brm(
  formula = events ~ 1,
  family  = poisson(),
  data    = df,
  prior   = prior_lambda,
  iter    = 3000, warmup = 1000, chains = 4, seed = 123
)
```

Otteniamo un riepilogo:

```{r}
summary(m0)
```

## Interpretazione dei risultati

Per ottenere direttamente i valori del tasso $\lambda$ (non il log), possiamo trasformare i campioni posteriori dell’intercetta:

```{r}
posterior_lambda <- as_draws(m0) %>%
  spread_draws(b_Intercept) %>%
  mutate(lambda = exp(b_Intercept))
```

Otteniamo la stima e l’intervallo di credibilità al 94%:

```{r}
posterior_lambda %>%
  median_qi(lambda, .width = 0.94)
```

## Visualizzazione

```{r}
posterior_lambda %>%
  ggplot(aes(x = lambda)) +
  stat_halfeye(fill = "skyblue", alpha = 0.6) +
  labs(
    title = "Distribuzione a posteriori del tasso λ",
    x = "Tasso annuo di sparatorie fatali (λ)",
    y = "Densità"
  )
```


## Estensione: confronto tra gruppi

Supponiamo di voler confrontare il tasso di sparatorie fatali **di vittime disarmate** tra due gruppi: persone bianche e non bianche.

### Filtraggio e aggregazione

```{r}
fps_unarmed <- subset(fps, armed_with == "unarmed")
white_df <- subset(fps_unarmed, race == "W")
non_white_df <- subset(fps_unarmed, race != "W")

count_white <- table(white_df$year)
count_non_white <- table(non_white_df$year)

df_white <- data.frame(year = as.numeric(names(count_white)), events = as.vector(count_white), group = "White")
df_nonwhite <- data.frame(year = as.numeric(names(count_non_white)), events = as.vector(count_non_white), group = "NonWhite")
df_groups <- rbind(df_white, df_nonwhite)
```

### Prior plausibile

Supponiamo una media a priori di circa 30 eventi l’anno con deviazione 10. Una lognormale approssimativa corrisponde a `normal(3.4, 0.3)` sulla scala logaritmica.

```{r}
prior_race <- c(
  prior(normal(3.4, 0.3), class = "b", coef = "groupWhite"),
  prior(normal(3.4, 0.3), class = "b", coef = "groupNonWhite")
)
```

### Modello con due gruppi

```{r}
#| message: false
#| warning: false
#| output: false
#| 
m_groups <- brm(
  formula = events ~ 0 + group,
  family  = poisson(),
  data    = df_groups,
  prior   = prior_race,
  iter = 3000, warmup = 1000, chains = 4, seed = 123
)
```

Otteniamo i tassi stimati:

```{r}
post <- posterior_samples(m_groups)
lambda_white <- exp(post$b_groupWhite)
lambda_nonwhite <- exp(post$b_groupNonWhite)
diff_lambda <- lambda_nonwhite - lambda_white
```

Intervallo credibile:

```{r}
median_qi(diff_lambda, .width = 0.94)
```


## Conclusioni

* Il tasso medio annuo stimato di vittime disarmate uccise dalla polizia è **più alto per il gruppo non caucasico** rispetto a quello caucasico.
* La **differenza media stimata** è di circa 11.5 casi l’anno, con un intervallo di credibilità al 94% che va da circa 6.8 a 16.4.
* I tassi stimati per ciascun gruppo sono:

  * **Non caucasici**: media ≈ 35.6 (CI: 32–39.3)
  * **Caucasici**: media ≈ 24.1 (CI: 21.1–27.3)

Questi risultati forniscono una base solida per affermare che il tasso di sparatorie fatali di vittime disarmate è più alto tra le persone non caucasiche.


## Esercizi {.unnumbered} 

::: {.callout-important title="Problemi" collapse="true"}

Nella finale olimpica di calcio 2024, la Spagna ha sconfitto la Francia per 5 a 3. Supponiamo di voler calcolare la probabilità di superiorità della Spagna rispetto alla Francia utilizzando un modello coniugato Gamma-Poisson (o l’approssimazione brms con prior lognormale).  

1. Considera che il numero di gol segnati da una squadra segua una Poisson con parametro $\lambda$.  
2. Specifica un prior su $\lambda$ per entrambe le squadre, ad esempio $\alpha=1$ e $\beta=1$ nella parametrizzazione Gamma classica (oppure una Normal(0,1.4) sull’intercetta, in modo da avere una media a posteriori analoga).  
3. Aggiorna la distribuzione a posteriori conoscendo i gol segnati (5 per la Spagna e 3 per la Francia in una singola partita).  
4. Calcola la probabilità che $\lambda_{\text{Spagna}} > \lambda_{\text{Francia}}$.  

*(Ispirato a “The World Cup Problem”, [@downey2021think].)*  

**Suggerimento:** puoi risolvere il problema in modo analitico (Gamma-Poisson con un solo conteggio) oppure puoi usare **brms** costruendo un dataframe:

```{r}
df_soccer <- data.frame(
  team = c("Spain", "France"),
  goals = c(5, 3)
)
```

- Modello: `goals ~ 0 + team`, `family=poisson()`.
- Prior su `b_teamSpain` e `b_teamFrance`.
- Infine, estrai i draws e calcola la probabilità $\Pr(\exp(b_{\text{Spain}}) > \exp(b_{\text{France}}))$.

:::

## Informazioni sull'Ambiente di Sviluppo {.unnumbered} 

```{r}
sessionInfo()
```

## Bibliografia {.unnumbered}


